name: Daily GitHub Trending Repos

on:
  schedule:
    # Cháº¡y má»—i ngÃ y lÃºc 6:00 AM
    - cron: '0 6 * * *'
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
    inputs:
      languages:
        description: 'Languages to filter (comma separated: python,javascript,rust)'
        required: false
        default: 'python,javascript,typescript,rust,go'

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Trending Repos by Language
        id: fetch
        env:
          GH_TOKEN: ${{ github.token }}
          LANGUAGES: ${{ github.event.inputs.languages || 'python,javascript,typescript,rust,go' }}
        run: |
          # Táº¡o file bÃ¡o cÃ¡o
          cat > daily-repos-report.md << 'EOF'
          # ðŸ“Š Daily GitHub Repos Report - $(date +%Y-%m-%d)

          > TÃ¬m kiáº¿m repos má»›i, nhiá»u star vá»›i má»¥c tiÃªu tÃ¡i sá»­ dá»¥ng thÆ°Æ¡ng máº¡i/cÃ¡ nhÃ¢n

          ---

          ## ðŸ”¥ Tá»•ng quan

          | NgÃ´n ngá»¯ | Repo | â­ Stars | ðŸ“œ License | MÃ´ táº£ |
          |----------|------|----------|-----------|-------|
          EOF

          # Danh sÃ¡ch ngÃ´n ngá»¯
          LANGUAGES="python,javascript,typescript,rust,go"

          # Fetch repos cho tá»«ng ngÃ´n ngá»¯
          for LANG in $(echo $LANGUAGES | tr ',' ' '); do
            echo "Fetching $LANG repos..."

            # Search repos with license only (thÆ°Æ¡ng máº¡i an toÃ n)
            curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/search/repositories?q=language:$LANG+created:>$(date -d '7 days ago' +%Y-%m-%d)+license:mit,apache-2.0,bsd-3-clause,unlicense&sort=stars&order=desc&per_page=10" \
              | jq -r --arg LANG "$LANG" '.items[] | "| \($LANG) | [\(.full_name)](\(.html_url)) | â­ \(.stargazers_count) | \(.license.spdx_id // "N/A") | \(.description // "No description")|"' \
              >> daily-repos-report.md
          done

          # ThÃªm pháº§n phÃ¢n nhÃ³m theo topic
          cat >> daily-repos-report.md << 'EOF'

          ---

          ## ðŸ¤– AI/ML Repos (Hot trends)

          | Repo | â­ | ðŸ“œ License | MÃ´ táº£ |
          |------|-----|-----------|-------|
          EOF

          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:ai+OR+topic:machine-learning+OR+topic:llm+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=10" \
            | jq -r '.items[] | "| [\(.full_name)](\(.html_url)) | â­ \(.stargazers_count) | \(.license.spdx_id // "N/A") | \(.description // "No description")|"' \
            >> daily-repos-report.md

          cat >> daily-repos-report.md << 'EOF'

          ---

          ## â˜¸ï¸ DevOps/SRE Repos

          | Repo | â­ | ðŸ“œ License | MÃ´ táº£ |
          |------|-----|-----------|-------|
          EOF

          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:devops+OR+topic:sre+OR+topic:docker+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=10" \
            | jq -r '.items[] | "| [\(.full_name)](\(.html_url)) | â­ \(.stargazers_count) | \(.license.spdx_id // "N/A") | \(.description // "No description")|"' \
            >> daily-repos-report.md

          cat >> daily-repos-report.md << 'EOF'

          ---

          ## ðŸ”’ Security Repos

          | Repo | â­ | ðŸ“œ License | MÃ´ táº£ |
          |------|-----|-----------|-------|
          EOF

          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/search/repositories?q=topic:security+OR+topic:infosec+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=10" \
            | jq -r '.items[] | "| [\(.full_name)](\(.html_url)) | â­ \(.stargazers_count) | \(.license.spdx_id // "N/A") | \(.description // "No description")|"' \
            >> daily-repos-report.md

          cat >> daily-repos-report.md << 'EOF'

          ---

          ## ðŸ’¡ HÆ°á»›ng dáº«n sá»­ dá»¥ng License

          | License | ThÆ°Æ¡ng máº¡i | Modifiable | Private use |
          |---------|------------|------------|-------------|
          | MIT | âœ… | âœ… | âœ… |
          | Apache 2.0 | âœ… | âœ… | âœ… |
          | BSD-3-Clause | âœ… | âœ… | âœ… |
          | Unlicense | âœ… | âœ… | âœ… |
          | GPLv3 | âš ï¸ | âš ï¸ | âœ… |
          | No License | âŒ | âŒ | âŒ |

          ---

          *Generated by GitHub Action - $(date)*
          EOF

          # Hiá»ƒn thá»‹ káº¿t quáº£
          echo "=== REPORT PREVIEW ==="
          cat daily-repos-report.md

      - name: Commit and push report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add daily-repos-report.md
          git commit -m "Update daily repos report - $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push

      - name: Send Discord Notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -s -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "ðŸ“Š Daily GitHub Repos Report",
                  "description": "New trending repositories fetched successfully!",
                  "color": 3066993,
                  "footer": {"text": "GitHub Action"},
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                }]
              }'
          fi

      - name: Send Slack Notification
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -s -X POST "$SLACK_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "ðŸ“Š *Daily GitHub Repos Report* - New trending repositories fetched! <${{ github.server_url }}/${{ github.repository }}/blob/main/daily-repos-report.md|View Report>"
              }'
          fi
