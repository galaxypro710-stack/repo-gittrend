name: Daily GitHub Trending Repos

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch repos
        id: fetch
        run: |
          # Simple test - check if token works
          echo "Testing GitHub API..."
          RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" "https://api.github.com/user")
          echo "User: $(echo $RESPONSE | jq -r '.login')"

          # Fetch trending Python repos (simple query)
          echo "Fetching Python repos..."
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:python+stars:>10&sort=stars&order=desc&per_page=5" \
            > repos.json

          echo "Fetched $(cat repos.json | jq '.total_count') repos"
          cat repos.json | jq '.items[] | "\(.full_name) - \(.stargazers_count) stars"' | head -10

      - name: Create report
        run: |
          cat > daily-repos-report.md << 'EOF'
          # ðŸ“Š Daily GitHub Repos Report

          ## Python Repos

          EOF

          cat repos.json | jq -r '.items[] | "- **[\(.full_name)](\(.html_url))** - â­ \(.stargazers_count) stars" + "\n  > \(.description // "No description")"' >> daily-repos-report.md

          echo "Report created:"
          cat daily-repos-report.md

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add daily-repos-report.md repos.json
          git commit -m "Update report - $(date +%Y-%m-%d)" || echo "No changes"
          git push
