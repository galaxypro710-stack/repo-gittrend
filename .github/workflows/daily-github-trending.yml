name: Daily GitHub Trending Repos

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python and jq
        run: |
          sudo apt-get update -qq && sudo apt-get install -y python3 python3-pip jq

      - name: Fetch repos by language
        run: |
          echo "Fetching repos..."

          # Test API first
          USER=$(curl -s -H "Authorization: token ${{ github.token }}" "https://api.github.com/user" | jq -r '.login')
          echo "Authenticated as: $USER"

          # Fetch repos for each language
          LANGUAGES="python javascript typescript rust go java cpp csharp"

          for LANG in $LANGUAGES; do
            echo "Fetching $LANG..."
            curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/search/repositories?q=language:$LANG+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=10" \
              > "repos_$LANG.json"
          done

          echo "Done fetching!"

      - name: Process repos
        run: |
          python3 << 'PYEOF'
          import json
          import os

          repos = []
          seen = set()

          # Read all language files
          for filename in os.listdir('.'):
            if filename.startswith('repos_') and filename.endswith('.json'):
              with open(filename, 'r') as f:
                data = json.load(f)
                for repo in data.get('items', []):
                  if repo['full_name'] not in seen:
                    seen.add(repo['full_name'])
                    repos.append({
                      'name': repo['full_name'],
                      'url': repo['html_url'],
                      'stars': repo['stargazers_count'],
                      'forks': repo['forks_count'],
                      'description': repo['description'] or 'No description',
                      'language': repo['language'],
                      'license': repo['license']['spdx_id'] if repo.get('license') else 'No License',
                      'topics': repo.get('topics', [])[:5],
                    })

          # Sort by stars
          repos.sort(key=lambda x: x['stars'], reverse=True)

          with open('repos_processed.json', 'w') as f:
            json.dump(repos[:50], f, indent=2)

          print(f"Total: {len(repos)} repos")
          PYEOF

      - name: Generate AI analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "No GEMINI_API_KEY, skipping AI"
            exit 0
          fi

          # Create prompt
          python3 << 'PYEOF'
          import json

          with open('repos_processed.json', 'r') as f:
            repos = json.load(f)

          prompt = """Ph√¢n t√≠ch 15 repo GitHub sau (top theo stars). M·ªói repo 1-2 c√¢u:

1. Repo l√†m g√¨?
2. D√πng ƒë∆∞·ª£c cho: dev, auto, agent, marketing, custom b√°n?
3. Ki·∫øm ti·ªÅn ƒë∆∞·ª£c kh√¥ng?

"""
          for i, repo in enumerate(repos[:15], 1):
            prompt += f"{i}. {repo['name']} ({repo['language']}) - ‚≠ê{repo['stars']} - {repo['description'][:80]}...\n"

          prompt += """

Format markdown table:
| # | Repo | M√¥ t·∫£ ng·∫Øn | Ti·ªÅm nƒÉng | Ki·∫øm ti·ªÅn |
|---|------|------------|-----------|-----------|
| 1 | ... | ... | dev/auto/agent | ‚úÖ/‚ö†Ô∏è/‚ùå |"""

          with open('prompt.txt', 'w') as f:
            f.write(prompt)

          print("Prompt ready")
          PYEOF

          # Call Gemini
          PROMPT=$(cat prompt.txt)
          # Escape for JSON
          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"contents\": [{\"parts\": [{\"text\": $PROMPT_ESCAPED}]}]}")

          echo "$RESPONSE" > gemini_raw.json

          if echo "$RESPONSE" | jq -e '.candidates[0].content.parts[0].text' > /dev/null 2>&1; then
            echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' > gemini_analysis.md
            echo "Gemini OK!"
          else
            echo "Gemini error"
            cat gemini_raw.json
          fi

      - name: Create report
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime

          with open('repos_processed.json', 'r') as f:
            repos = json.load(f)

          today = datetime.now().strftime('%Y-%m-%d')

          report = f"""# üìä Daily GitHub Repos Report - {today}

> Top repo GitHub m·ªõi, nhi·ªÅu star - Ph√¢n t√≠ch ti·ªÅm nƒÉng & ki·∫øm ti·ªÅn

---

## üî• Top 50 Repos

| # | Ng√¥n ng·ªØ | Repo | ‚≠ê Stars | üç¥ Forks | üìú License |
|---|----------|------|----------|----------|------------|
"""

          for i, repo in enumerate(repos[:50], 1):
            report += f"| {i} | {repo['language']} | [{repo['name']}]({repo['url']}) | {repo['stars']:,} | {repo['forks']:,} | {repo['license']} |\n"

          # Details for top 20
          report += "\n---\n\n## üìù Chi ti·∫øt Top 20\n\n"
          for i, repo in enumerate(repos[:20], 1):
            topics = ', '.join(repo['topics']) if repo['topics'] else 'None'
            report += f"""### {i}. [{repo['name']}]({repo['url']})

- ‚≠ê **{repo['stars']:,}** | üç¥ {repo['forks']:,} | üó£Ô∏è {repo['language']} | üìú {repo['license']}
- üìÅ Topics: {topics}
- üìù {repo['description']}

"""

          # Add Gemini analysis
          try:
            with open('gemini_analysis.md', 'r') as f:
              gemini = f.read()
            if len(gemini) > 100:
              report += f"""---

## ü§ñ Ph√¢n t√≠ch AI (Gemini)

{gemini}

"""
          except:
            pass

          report += f"""---

## üí° License & Ki·∫øm ti·ªÅn

| License | Th∆∞∆°ng m·∫°i | Custom/B√°n |
|---------|------------|------------|
| MIT | ‚úÖ | ‚úÖ |
| Apache 2.0 | ‚úÖ | ‚úÖ |
| BSD-3-Clause | ‚úÖ | ‚úÖ |
| Unlicense | ‚úÖ | ‚úÖ |
| GPLv3 | ‚ö†Ô∏è | ‚ùå |
| No License | ‚ùå | ‚ùå |

*Generated: {today}*
"""

          with open('daily-repos-report.md', 'w') as f:
            f.write(report)

          print("Report created!")
          PYEOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update report - $(date +%Y-%m-%d)" || echo "No changes"
          git push
