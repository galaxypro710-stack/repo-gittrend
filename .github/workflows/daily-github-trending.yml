name: Daily GitHub Trending Repos

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch repos by language
        run: |
          echo "Testing API..."
          USER=$(curl -s -H "Authorization: token ${{ github.token }}" "https://api.github.com/user" | jq -r '.login')
          echo "User: $USER"

          # Fetch multiple languages
          LANGUAGES="python javascript typescript rust go java cpp csharp"

          echo "Fetching repos..."
          > all_repos.json
          echo '[' >> all_repos.json

          FIRST=true
          for LANG in $LANGUAGES; do
            echo "Fetching $LANG..."
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> all_repos.json
            fi
            curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/search/repositories?q=language:$LANG+stars:>100+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=20" \
              | jq '.items' >> all_repos.json
          done

          echo ']' >> all_repos.json
          echo "Done fetching"

      - name: Process repos
        run: |
          python3 << 'PYEOF'
          import json

          with open('all_repos.json', 'r') as f:
            data = json.load(f)

          repos = []
          seen = set()

          for lang_items in data:
            for repo in lang_items:
              if repo['full_name'] not in seen:
                seen.add(repo['full_name'])
                repos.append({
                  'name': repo['full_name'],
                  'url': repo['html_url'],
                  'stars': repo['stargazers_count'],
                  'forks': repo['forks_count'],
                  'description': repo['description'] or 'No description',
                  'language': repo['language'],
                  'license': repo['license']['spdx_id'] if repo.get('license') else 'No License',
                  'topics': repo.get('topics', [])[:5],
                  'created': repo['created_at'][:10],
                  'pushed': repo['pushed_at'][:10]
                })

          # Sort by stars descending
          repos.sort(key=lambda x: x['stars'], reverse=True)

          with open('repos_processed.json', 'w') as f:
            json.dump(repos[:60], f, indent=2)

          print(f"Total: {len(repos)} repos, saved top 60")
          PYEOF

      - name: Create report
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime

          with open('repos_processed.json', 'r') as f:
            repos = json.load(f)

          today = datetime.now().strftime('%Y-%m-%d')

          # Group by language
          by_lang = {}
          for r in repos:
            lang = r['language']
            if lang not in by_lang:
              by_lang[lang] = []
            by_lang[lang].append(r)

          report = f"""# ðŸ“Š Daily GitHub Repos Report - {today}

> Top repo GitHub má»›i, nhiá»u star - Filter: stars>100, created<30 days

---

## ðŸ”¥ All Top Repos (Sorted by Stars)

| # | NgÃ´n ngá»¯ | Repo | â­ Stars | ðŸ´ Forks | ðŸ“œ License |
|---|----------|------|----------|----------|------------|
"""

          for i, repo in enumerate(repos[:60], 1):
            report += f"| {i} | {repo['language']} | [{repo['name']}]({repo['url']}) | {repo['stars']:,} | {repo['forks']:,} | {repo['license']} |\n"

          # Group by language
          report += "\n---\n\n## ðŸ—‚ï¸ By Language\n\n"

          for lang in ['Python', 'JavaScript', 'TypeScript', 'Rust', 'Go', 'Java', 'C++', 'C#']:
            if lang in by_lang:
              report += f"### ðŸ—£ï¸ {lang}\n\n"
              for repo in by_lang[lang][:10]:
                report += f"- [{repo['name']}]({repo['url']}) - â­{repo['stars']:,} | ðŸ´{repo['forks']:,} | {repo['license']}\n"
                report += f"  - {repo['description'][:100]}...\n\n"

          # Top by forks (trending)
          by_forks = sorted(repos, key=lambda x: x['forks'], reverse=True)[:20]
          report += "\n---\n\n## ðŸ“ˆ Trending (Top Forks)\n\n"
          for i, repo in enumerate(by_forks, 1):
            report += f"{i}. [{repo['name']}]({repo['url']}) - â­{repo['stars']:,} | ðŸ´{repo['forks']:,} | {repo['language']}\n"

          # Best licenses for commercial use
          commercial_licenses = ['MIT', 'Apache-2.0', 'BSD-3-Clause', 'Unlicense']
          commercial = [r for r in repos if r['license'] in commercial_licenses]
          report += "\n---\n\n## ðŸ’° Best for Commercial (MIT/Apache/BSD/Unlicense)\n\n"
          for i, repo in enumerate(commercial[:20], 1):
            report += f"{i}. [{repo['name']}]({repo['url']}) - â­{repo['stars']:,} | ðŸ´{repo['forks']:,} | {repo['license']} | {repo['language']}\n"

          report += f"""

---

## ðŸ’¡ License Guide

| License | ThÆ°Æ¡ng máº¡i | Custom/BÃ¡n |
|---------|------------|------------|
| MIT | âœ… | âœ… |
| Apache 2.0 | âœ… | âœ… |
| BSD-3-Clause | âœ… | âœ… |
| Unlicense | âœ… | âœ… |
| GPLv3 | âš ï¸ | âŒ |
| No License | âŒ | âŒ |

*Generated: {today}*
"""

          with open('daily-repos-report.md', 'w') as f:
            f.write(report)

          print("Report created!")
          PYEOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update report - $(date +%Y-%m-%d)" || echo "No changes"
          git push
