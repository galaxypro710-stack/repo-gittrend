name: Daily GitHub Trending Repos

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Python repos
        run: |
          echo "=== Fetching Python repos ==="
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:python+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
            > python_repos.json

      - name: Fetch JavaScript repos
        run: |
          echo "=== Fetching JavaScript repos ==="
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:javascript+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
            > js_repos.json

      - name: Fetch TypeScript repos
        run: |
          echo "=== Fetching TypeScript repos ==="
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:typescript+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
            > ts_repos.json

      - name: Fetch Rust repos
        run: |
          echo "=== Fetching Rust repos ==="
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:rust+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
            > rust_repos.json

      - name: Fetch Go repos
        run: |
          echo "=== Fetching Go repos ==="
          curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/search/repositories?q=language:go+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
            > go_repos.json

      - name: Create report
        run: |
          TODAY=$(date +%Y-%m-%d)

          cat > daily-repos-report.md << EOF
          # ğŸ“Š Daily GitHub Repos Report - $TODAY

          > Filter: stars > 50, created < 30 days

          ---

          ## ğŸ Python Repos

          | â­ Stars | ğŸ´ Forks | Repo | License |
          |----------|----------|------|---------|
          EOF

          cat python_repos.json | jq -r '.items[] | "| \(.stargazers_count) | \(.forks_count) | [\(.full_name)](\(.html_url)) | \(.license.spdx_id // "N/A") |" ' >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸŒ JavaScript Repos

          | â­ Stars | ğŸ´ Forks | Repo | License |
          |----------|----------|------|---------|
          EOF

          cat js_repos.json | jq -r '.items[] | "| \(.stargazers_count) | \(.forks_count) | [\(.full_name)](\(.html_url)) | \(.license.spdx_id // "N/A") |" ' >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸ’ TypeScript Repos

          | â­ Stars | ğŸ´ Forks | Repo | License |
          |----------|----------|------|---------|
          EOF

          cat ts_repos.json | jq -r '.items[] | "| \(.stargazers_count) | \(.forks_count) | [\(.full_name)](\(.html_url)) | \(.license.spdx_id // "N/A") |" ' >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## âš™ï¸ Rust Repos

          | â­ Stars | ğŸ´ Forks | Repo | License |
          |----------|----------|------|---------|
          EOF

          cat rust_repos.json | jq -r '.items[] | "| \(.stargazers_count) | \(.forks_count) | [\(.full_name)](\(.html_url)) | \(.license.spdx_id // "N/A") |" ' >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸ¹ Go Repos

          | â­ Stars | ğŸ´ Forks | Repo | License |
          |----------|----------|------|---------|
          EOF

          cat go_repos.json | jq -r '.items[] | "| \(.stargazers_count) | \(.forks_count) | [\(.full_name)](\(.html_url)) | \(.license.spdx_id // "N/A") |" ' >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸ’° Commercial Ready (MIT/Apache/BSD)

          Repos cÃ³ license cho phÃ©p thÆ°Æ¡ng máº¡i vÃ  custom:

          | Language | Repo | â­ | License |
          |----------|------|-----|---------|
          EOF

          for f in python_repos.json js_repos.json ts_repos.json rust_repos.json go_repos.json; do
            cat $f | jq -r '.items[] | select(.license.spdx_id | . and (. == "MIT" or . == "Apache-2.0" or . == "BSD-3-Clause" or . == "Unlicense")) | "| \($f | gsub("_repos.json";"")) | [\(.full_name)](\(.html_url)) | \(.stargazers_count) | \(.license.spdx_id) |" '
          done >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸ“ˆ Trending by Forks

          | ğŸ´ Forks | â­ Stars | Repo | Language |
          |----------|----------|------|----------|
          EOF

          for f in python_repos.json js_repos.json ts_repos.json rust_repos.json go_repos.json; do
            cat $f | jq -r '.items[] | "| \(.forks_count) | \(.stargazers_count) | [\(.full_name)](\(.html_url)) | \($f | gsub("_repos.json";"")) |" '
          done | sort -t'|' -k1 -rn | head -20 >> daily-repos-report.md

          cat >> daily-repos-report.md << EOF

          ---

          ## ğŸ’¡ License Guide

          | License | ThÆ°Æ¡ng máº¡i | Custom/BÃ¡n |
          |---------|------------|------------|
          | MIT | âœ… | âœ… |
          | Apache 2.0 | âœ… | âœ… |
          | BSD-3-Clause | âœ… | âœ… |
          | Unlicense | âœ… | âœ… |
          | GPLv3 | âš ï¸ | âŒ |
          | No License | âŒ | âŒ |

          *Generated: $TODAY*
          EOF

          echo "Report created!"
          cat daily-repos-report.md

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update report - $(date +%Y-%m-%d)" || echo "No changes"
          git push
