name: Daily GitHub Trending Repos

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  fetch-trending:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch repos by language
        id: fetch
        run: |
          echo "Fetching repos..."

          # Fetch multiple languages
          LANGUAGES="python,javascript,typescript,rust,go,java,cpp,csharp"

          # Initialize JSON array
          echo '[' > repos.json

          FIRST=true
          for LANG in $(echo $LANGUAGES | tr ',' ' '); do
            echo "Fetching $LANG..."
            curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/search/repositories?q=language:$LANG+stars:>50+created:>$(date -d '30 days ago' +%Y-%m-%d)&sort=stars&order=desc&per_page=15" \
              >> repos.json.tmp
            echo "," >> repos.json.tmp
          done

          # Clean up JSON
          cat repos.json.tmp | head -c -2 >> repos.json
          echo ']' >> repos.json
          rm repos.json.tmp

          echo "Total repos fetched: $(cat repos.json | jq '.[] | length' | bc 2>/dev/null || echo '0')"

      - name: Process repos
        run: |
          # Extract repos with star, fork, description
          cat > process.py << 'PYEOF'
          import json

          with open('repos.json', 'r') as f:
            data = json.load(f)

          repos = []
          seen = set()
          for lang_repos in data:
            for repo in lang_repos.get('items', []):
              if repo['full_name'] not in seen:
                seen.add(repo['full_name'])
                repos.append({
                  'name': repo['full_name'],
                  'url': repo['html_url'],
                  'stars': repo['stargazers_count'],
                  'forks': repo['forks_count'],
                  'description': repo['description'] or 'No description',
                  'language': repo['language'],
                  'license': repo['license']['spdx_id'] if repo.get('license') else 'No License',
                  'topics': repo.get('topics', [])[:5],
                  'created': repo['created_at'][:10],
                  'pushed': repo['pushed_at'][:10]
                })

          # Sort by stars
          repos.sort(key=lambda x: x['stars'], reverse=True)

          with open('repos_processed.json', 'w') as f:
            json.dump(repos[:50], f, indent=2)

          print(f"Processed {len(repos)} unique repos")
          PYEOF

          python3 process.py

      - name: Generate prompt for Gemini
        run: |
          python3 << 'PYEOF'
          import json

          with open('repos_processed.json', 'r') as f:
            repos = json.load(f)

          # Take top 20 repos for Gemini analysis (to avoid rate limits)
          prompt = """Báº¡n lÃ  chuyÃªn gia phÃ¢n tÃ­ch repo GitHub. HÃ£y phÃ¢n tÃ­ch cÃ¡c repo sau vÃ  Ä‘Æ°a ra Ä‘Ã¡nh giÃ¡ ngáº¯n gá»n (má»—i repo 1-2 cÃ¢u):

1. Repo nÃ y lÃ m gÃ¬?
2. Tiá»m nÄƒng sá»­ dá»¥ng cho: dev, auto, agent, marketing, custom thÆ°Æ¡ng máº¡i?
3. CÃ³ thá»ƒ kiáº¿m tiá»n (custom/bÃ¡n) Ä‘Æ°á»£c khÃ´ng?

Danh sÃ¡ch repo (top 20 theo stars):

"""
          for i, repo in enumerate(repos[:20], 1):
            prompt += f"{i}. **{repo['name']}** ({repo['language']}) - â­{repo['stars']} | {repo['description'][:100]}\n"

          prompt += """

Format tráº£ lá»i (markdown table):
| # | Repo | MÃ´ táº£ | Tiá»m nÄƒng | Kiáº¿m tiá»n? |
|---|------|-------|-----------|------------|
| 1 | name | ... | dev/auto/agent/marketing | âœ…/âš ï¸/âŒ |

Chá»‰ tráº£ lá»i báº±ng tiáº¿ng Viá»‡t, ngáº¯n gá»n, thá»±c táº¿."""

          with open('gemini_prompt.txt', 'w') as f:
            f.write(prompt)

          print("Prompt generated for Gemini")
          print(f"Prompt length: {len(prompt)} chars")
          PYEOF

      - name: Call Gemini API
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY not set, skipping AI analysis"
            echo "## AI Analysis" >> daily-repos-report.md
            echo "âš ï¸ Cáº§n thÃªm GEMINI_API_KEY Ä‘á»ƒ phÃ¢n tÃ­ch AI" >> daily-repos-report.md
            exit 0
          fi

          echo "Calling Gemini API..."
          PROMPT=$(cat gemini_prompt.txt)

          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"contents\": [{\"parts\": [{\"text\": \"$PROMPT\"}]}], \"generationConfig\": {\"temperature\": 0.7, \"maxOutputTokens\": 4000}}" 2>/dev/null)

          if echo "$RESPONSE" | jq -e '.candidates[0].content.parts[0].text' > /dev/null 2>&1; then
            echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text' > gemini_response.txt
            echo "Gemini response received"
          else
            echo "Gemini API error:"
            echo "$RESPONSE" | jq '.'
            echo "AI Analysis failed" > gemini_response.txt
          fi

      - name: Create report
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime

          with open('repos_processed.json', 'r') as f:
            repos = json.load(f)

          today = datetime.now().strftime('%Y-%m-%d')

          report = f"""# ðŸ“Š Daily GitHub Repos Report - {today}

> Tá»•ng há»£p repo GitHub má»›i, nhiá»u star - PhÃ¢n tÃ­ch tiá»m nÄƒng sá»­ dá»¥ng & kiáº¿m tiá»n

---

## ðŸ“ˆ Top 50 Repos (Sorted by Stars)

| # | NgÃ´n ngá»¯ | Repo | â­ Stars | ðŸ´ Forks | ðŸ“œ License |
|---|----------|------|----------|----------|------------|
"""

          for i, repo in enumerate(repos[:50], 1):
            report += f"| {i} | {repo['language']} | [{repo['name']}]({repo['url']}) | {repo['stars']:,} | {repo['forks']:,} | {repo['license']} |\n"

          # Add description section
          report += """

---

## ðŸ“ Top Repos - Chi tiáº¿t

"""

          for i, repo in enumerate(repos[:20], 1):
            topics = ', '.join(repo['topics']) if repo['topics'] else 'No topics'
            report += f"""### {i}. [{repo['name']}]({repo['url']})

- **â­ Stars**: {repo['stars']:,} | **ðŸ´ Forks**: {repo['forks']:,}
- **ðŸ—£ï¸ NgÃ´n ngá»¯**: {repo['language']}
- **ðŸ“œ License**: {repo['license']}
- **ðŸ“ Topics**: {topics}
- **ðŸ“… Created**: {repo['created']} | **Updated**: {repo['pushed']}
- **ðŸ“ MÃ´ táº£**: {repo['description']}

---

"""

          # Add Gemini analysis if available
          try:
            with open('gemini_response.txt', 'r') as f:
              gemini_response = f.read()
            if gemini_response and len(gemini_response) > 50:
              report += f"""---

## ðŸ¤– PhÃ¢n tÃ­ch AI (Gemini)

{gemini_response}

"""
          except:
            pass

          report += f"""---

## ðŸ’¡ HÆ°á»›ng dáº«n License

| License | ThÆ°Æ¡ng máº¡i | Modifiable | BÃ¡n custom |
|---------|------------|------------|-------------|
| MIT | âœ… | âœ… | âœ… |
| Apache 2.0 | âœ… | âœ… | âœ… |
| BSD-3-Clause | âœ… | âœ… | âœ… |
| Unlicense | âœ… | âœ… | âœ… |
| GPLv3 | âš ï¸ | âœ… | âŒ |
| No License | âŒ | âŒ | âŒ |

---

*Generated by GitHub Action - {today}*
"""

          with open('daily-repos-report.md', 'w') as f:
            f.write(report)

          print("Report created!")
          print(f"Total repos: {len(repos)}")
          PYEOF

          cat daily-repos-report.md

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add daily-repos-report.md repos.json repos_processed.json 2>/dev/null || true
          git commit -m "Update report - $(date +%Y-%m-%d)" || echo "No changes"
          git push
